IPsec (Internet Protocol Security) is a protocol suite used to encrypt and authenticate IP packets in order to secure network communications. IPsec can be used to create a virtual private network (VPN) between two endpoints, such as two branch offices of a company or a remote worker and a company's network. 

IPsec uses two protocols to provide security: the Authentication Header (AH) protocol and the Encapsulating Security Payload (ESP) protocol. AH provides authentication and integrity protection for IP packets, while ESP provides confidentiality, authentication, and integrity protection. 

When IPsec is used to create a VPN, the original IP packet is encapsulated within an outer IP packet that is encrypted and authenticated. This outer packet is known as the IPsec packet or the ESP packet. The outer packet contains a new IP header with a temporary session IP address that is negotiated during the IPsec handshake process. The session IP address is used to route the packet between the two endpoints of the tunnel. Once the packet reaches the destination endpoint, the outer IP header is removed and the original IP packet is extracted and processed as if it had been sent directly between the two endpoints. 

The handshake protocol used in IPsec is called the Internet Key Exchange (IKE) protocol. IKE is used to establish the security association (SA) between the two endpoints of the IPsec tunnel, which includes negotiating the encryption and authentication algorithms to be used, exchanging keys, and verifying the identity of each endpoint. There are two phases in the IKE protocol: Phase 1 and Phase 2. Phase 1 establishes the ISAKMP (Internet Security Association and Key Management Protocol) SA, which is used to protect the IKE messages themselves. Phase 2 establishes the IPsec SA, which is used to protect the data traffic between the two endpoints. 

ISAKMP is a separate protocol that is used to establish the initial security association (SA) between the two endpoints of an IPsec tunnel. The ISAKMP SA is used to protect the IKE messages themselves, including negotiating the encryption and authentication algorithms to be used, exchanging keys, and verifying the identity of each endpoint. Once the ISAKMP SA is established, the IKE protocol is used to establish the IPsec SA, which is used to protect the data traffic between the two endpoints. The IPsec SA includes the encryption and authentication algorithms to be used, as well as the keys that will be used to encrypt and decrypt the data traffic. 

Overall, IPsec provides a secure way to transmit data over an untrusted network, such as the Internet. By encrypting and authenticating IP packets, IPsec ensures that the data is protected from eavesdropping, tampering, and other attacks. The IKE protocol is used to establish the security association between the two endpoints of the IPsec tunnel, which includes negotiating the encryption and authentication algorithms to be used, exchanging keys, and verifying the identity of each endpoint